name: Test Inputs in RunTime

on:
  workflow_call:
    inputs:
      varfile_path:
        description: 'Path to the directory containing the variable files'
        required: true
        type: string
    outputs:
      varfile:
        description: "The varfile output."
        value: ${{ jobs.test.outputs.varfile }}
  workflow_dispatch:
    inputs:
      varfile_path:
        description: 'Path to the directory containing the variable files'
        required: true
        type: string

permissions:
  contents: write
  issues: write

jobs:
  test:
    runs-on: ubuntu-latest
    outputs:
      varfile: ${{ steps.wait-for-input.outputs.var_file }}

    steps:

      - name: Create Issue Requesting Variable File
        id: create-issue
        uses: actions/github-script@v6
        with:
          script: |
            const issue = await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'Specify Variable File for Terraform Plan',
              body: 'Please specify the variable file to use for Terraform plan by commenting with `varfile.tfvars`.'
            });
            core.setOutput("issue_number", issue.data.number);

      - name: Wait for User Input and Check Variable File
        id: wait-for-input
        uses: actions/github-script@v6
        with:
          script: |
            const issue_number = `${{ steps.create-issue.outputs.issue_number }}`;
            const regex = /.*\.tfvars$/;
            let varFile = '';
            const varfilePath = `${{ github.event.inputs.varfile_path }}`;

            while (!varFile) {
              const { data: comments } = await github.rest.issues.listComments({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue_number
              });

              const lastComment = comments.length > 0 ? comments[comments.length - 1] : null;
              
              if (lastComment && lastComment.user.login !== 'github-actions[bot]') {
                if (regex.test(lastComment.body)) {
                
                  varFile = lastComment.body;
                
                  // Check if the file exists in the repository
                  const exists = await github.rest.repos.getContent({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    path: `${varfilePath}/${varFile}`
                  }).then(() => true).catch(() => false);

                  if (exists) {
                    await github.rest.issues.createComment({
                      owner: context.repo.owner,
                      repo: context.repo.repo,
                      issue_number: issue_number,
                      body: `Variable file set to \`${varFile}\`. Continuing with the workflow.`
                    });
                    console.log(`Variable file set to ${varFile}. Continuing with the workflow.`);
                  } else {
                    await github.rest.issues.createComment({
                      owner: context.repo.owner,
                      repo: context.repo.repo,
                      issue_number: issue_number,
                      body: `The file \`${varFile}\` does not exist in the repository. Please specify another variable file to use for Terraform plan by commenting with \`varfile.tfvars\`.`
                    });
                    console.log(`The file ${varFile} does not exist in the repository. Please specify another variable file to use for Terraform plan.`);
                    varFile = '';
                  }
                } else {
                  await github.rest.issues.createComment({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    issue_number: issue_number,
                    body: `The comment \`${lastComment.body}\` is not valid. Please specify the variable file to use for Terraform plan by commenting with \`varfile.tfvars\`.`
                  });
                  console.log( `The comment ${lastComment.body} is not valid. Please specify the variable file to use for Terraform plan.`);
                }
              }
              if (!varFile) {
                console.log('Waiting for user input...');
                await new Promise(resolve => setTimeout(resolve, 15000)); // Wait 15 seconds before checking again
              }
            }

            core.setOutput("var_file", varFile);

      - name: Close Issue on Success/Failure/Cancel
        if: success() || failure() || cancelled()
        uses: actions/github-script@v6
        with:
          script: |
            const issue_number = `${{ steps.create-issue.outputs.issue_number }}`;
            const conclusion = `${{ job.status }}`
            let commentBody = '';

            switch (conclusion) {
              case 'success':
                commentBody = 'The workflow completed successfully. Closing the issue.';
                break;
              case 'failure':
                commentBody = 'The workflow encountered issues and failed. Closing the issue.';
                break;
              case 'cancelled':
                commentBody = 'The workflow was cancelled. Closing the issue.';
                break;
              default:
                commentBody = 'Unknown workflow conclusion. Closing the issue.';
            }

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issue_number,
              body: commentBody
            });

            await github.rest.issues.update({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issue_number,
              state: 'closed'
            });

      - name: Test Echo
        run: echo "${{ steps.wait-for-input.outputs.var_file }}"
